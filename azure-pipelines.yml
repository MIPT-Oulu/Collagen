# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

jobs:
- job: 'Test'
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python37:
        python.version: '3.7'
    maxParallel: 2

  steps:
  - bash: echo "##vso[task.prependpath]/usr/share/miniconda/bin"
    displayName: Adding conda to PATH

  - bash: conda create --yes --quiet --name collagen_test_env python=$PYTHON_VERSION 
    displayName: Creating Anaconda environment

  - bash: conda install -y -n collagen_test_env numpy scipy pandoc
    displayName: 'Installing basic dependencies'

  - bash: conda install -y -n collagen_test_env torch torchvision
    displayName: 'Installing CV dependencies'

  - bash: conda install -y -n collagen_test_env torch torchvision -c pytorch
    displayName: 'Installing CV dependencies from conda'

  - bash: |
      source activate collagen_test_env
      pip install solt pytest pytest-flake8 ipykernel codecov pytest-pep8 coverage pytest-cov sphinx
    displayName: 'Installing testing and docs building dependencies'

  - bash: |
      source activate collagen_test_env
      pip install -e .
    displayName: 'Installing Collagen'
    
  - bash: |
      source activate collagen_test_env
      py.test tests
    displayName: 'Running the tests'
